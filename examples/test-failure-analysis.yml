name: Auto-Retry Flaky Tests

# ì´ ì˜ˆì œëŠ” êµ¬ì¡°í™”ëœ ì¶œë ¥ì„ ì‚¬ìš©í•˜ì—¬ ë¶ˆì•ˆì •í•œ(flaky) í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¥¼ ê°ì§€í•˜ê³ 
# ìë™ìœ¼ë¡œ ì¬ì‹œë„í•˜ì—¬ ê°„í—ì  ì‹¤íŒ¨ë¡œ ì¸í•œ ë…¸ì´ì¦ˆë¥¼ ì¤„ì´ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
#
# ì‚¬ìš© ì‚¬ë¡€: CIê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ, ë¶ˆì•ˆì •í•œ í…ŒìŠ¤íŠ¸ì¸ì§€ ìë™ìœ¼ë¡œ íŒë³„í•˜ê³  í•´ë‹¹ë˜ë©´ ì¬ì‹œë„í•©ë‹ˆë‹¤.

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

# ê¶Œí•œ ì„¤ì •: ì €ì¥ì†Œ ì½ê¸° ë° ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰ì„ ìœ„í•œ actions ì“°ê¸° ê¶Œí•œ í•„ìš”
permissions:
  contents: read
  actions: write

jobs:
  detect-flaky:
    runs-on: ubuntu-latest
    # CI ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      # ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Claudeë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶ˆì•ˆì •í•œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ ê°ì§€í•˜ëŠ” í•µì‹¬ ë‹¨ê³„
      # êµ¬ì¡°í™”ëœ JSON ì¶œë ¥ìœ¼ë¡œ is_flaky, confidence, summaryë¥¼ ë°˜í™˜
      - name: Detect flaky test failures
        id: detect
        uses: anthropics/claude-code-action@main
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            CI ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${{ github.event.workflow_run.html_url }}

            ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”: gh run view ${{ github.event.workflow_run.id }} --log-failed

            ë‹¤ìŒ í•­ëª©ì„ í™•ì¸í•˜ì—¬ ë¶ˆì•ˆì •í•œ(flaky) í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ì¸ì§€ íŒë³„í•˜ì„¸ìš”:
            - íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜
            - ê²½ìŸ ì¡°ê±´(Race condition)
            - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜
            - "Expected X but got Y" ê°™ì€ ê°„í—ì  ì‹¤íŒ¨
            - ì´ì „ ì»¤ë°‹ì—ì„œëŠ” í†µê³¼í–ˆë˜ í…ŒìŠ¤íŠ¸

            ë‹¤ìŒì„ ë°˜í™˜í•˜ì„¸ìš”:
            - is_flaky: ë¶ˆì•ˆì •í•œ í…ŒìŠ¤íŠ¸ì¼ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë©´ true, ì‹¤ì œ ë²„ê·¸ì´ë©´ false
            - confidence: íŒë³„ ì‹ ë¢°ë„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” 0~1 ì‚¬ì´ì˜ ìˆ«ì
            - summary: ì‹¤íŒ¨ ì›ì¸ì— ëŒ€í•œ ê°„ë‹¨í•œ í•œ ì¤„ ì„¤ëª…
          claude_args: |
            --json-schema '{"type":"object","properties":{"is_flaky":{"type":"boolean","description":"Whether this appears to be a flaky test failure"},"confidence":{"type":"number","minimum":0,"maximum":1,"description":"Confidence level in the determination"},"summary":{"type":"string","description":"One-sentence explanation of the failure"}},"required":["is_flaky","confidence","summary"]}'

      # ë¶ˆì•ˆì •í•œ í…ŒìŠ¤íŠ¸ë¡œ íŒë³„ë˜ê³  ì‹ ë¢°ë„ê°€ ë†’ì€ ê²½ìš°(>= 0.7)ì—ë§Œ ìë™ ì¬ì‹œë„
      - name: Retry flaky tests
        if: |
          fromJSON(steps.detect.outputs.structured_output).is_flaky == true &&
          fromJSON(steps.detect.outputs.structured_output).confidence >= 0.7
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          OUTPUT='${{ steps.detect.outputs.structured_output }}'
          CONFIDENCE=$(echo "$OUTPUT" | jq -r '.confidence')
          SUMMARY=$(echo "$OUTPUT" | jq -r '.summary')

          echo "ğŸ”„ Flaky test detected (confidence: $CONFIDENCE)"
          echo "Summary: $SUMMARY"
          echo ""
          echo "Triggering automatic retry..."

          # ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°ë¥¼ ë™ì¼ ë¸Œëœì¹˜ì—ì„œ ì¬ì‹¤í–‰
          gh workflow run "${{ github.event.workflow_run.name }}" \
            --ref "${{ github.event.workflow_run.head_branch }}"

      # ë¶ˆì•ˆì •í•œ í…ŒìŠ¤íŠ¸ë¡œ ì˜ì‹¬ë˜ì§€ë§Œ ì‹ ë¢°ë„ê°€ ë‚®ì€ ê²½ìš° - ì¬ì‹œë„í•˜ì§€ ì•ŠìŒ
      - name: Low confidence detection
        if: |
          fromJSON(steps.detect.outputs.structured_output).is_flaky == true &&
          fromJSON(steps.detect.outputs.structured_output).confidence < 0.7
        run: |
          OUTPUT='${{ steps.detect.outputs.structured_output }}'
          CONFIDENCE=$(echo "$OUTPUT" | jq -r '.confidence')

          echo "âš ï¸ Possible flaky test but confidence too low ($CONFIDENCE)"
          echo "Not retrying automatically - manual review recommended"

      # PR ë¹Œë“œì¸ ê²½ìš° ë¶„ì„ ê²°ê³¼ë¥¼ PRì— ì½”ë©˜íŠ¸ë¡œ ë‚¨ê¹€
      - name: Comment on PR
        if: github.event.workflow_run.event == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          OUTPUT='${{ steps.detect.outputs.structured_output }}'
          IS_FLAKY=$(echo "$OUTPUT" | jq -r '.is_flaky')
          CONFIDENCE=$(echo "$OUTPUT" | jq -r '.confidence')
          SUMMARY=$(echo "$OUTPUT" | jq -r '.summary')

          # í•´ë‹¹ ë¸Œëœì¹˜ì˜ PR ë²ˆí˜¸ë¥¼ ì¡°íšŒ
          pr_number=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number --jq '.[0].number')

          if [ -n "$pr_number" ]; then
            # ë¶ˆì•ˆì •í•œ í…ŒìŠ¤íŠ¸ ì—¬ë¶€ì— ë”°ë¼ ì½”ë©˜íŠ¸ ì œëª©ê³¼ ì¡°ì¹˜ ë‚´ìš©ì„ ì„¤ì •
            if [ "$IS_FLAKY" = "true" ]; then
              TITLE="ğŸ”„ Flaky Test Detected"
              ACTION="âœ… Automatically retrying the workflow"
            else
              TITLE="âŒ Test Failure"
              ACTION="âš ï¸ This appears to be a real bug - manual intervention needed"
            fi

            gh pr comment "$pr_number" --body "$(cat <<EOF
          ## $TITLE

          **Analysis**: $SUMMARY
          **Confidence**: $CONFIDENCE

          $ACTION

          [View workflow run](${{ github.event.workflow_run.html_url }})
          EOF
          )"
          fi
